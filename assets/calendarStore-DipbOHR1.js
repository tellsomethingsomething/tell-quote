import{ah as e,E as t}from"./index-DoA-9vkb.js";import{c as a}from"./zustand-vendor-BohoUguQ.js";const n="https://graph.microsoft.com/v1.0",o="https://www.googleapis.com/calendar/v3",s={tentative:{label:"Tentative",color:"text-yellow-400",bgColor:"bg-yellow-500/20"},confirmed:{label:"Confirmed",color:"text-green-400",bgColor:"bg-green-500/20"},cancelled:{label:"Cancelled",color:"text-red-400",bgColor:"bg-red-500/20"}},r={meeting:{label:"Meeting",icon:"ðŸ“…",color:"text-blue-400"},call:{label:"Call",icon:"ðŸ“ž",color:"text-green-400"},presentation:{label:"Presentation",icon:"ðŸ“Š",color:"text-purple-400"},deadline:{label:"Deadline",icon:"â°",color:"text-red-400"},reminder:{label:"Reminder",icon:"ðŸ””",color:"text-amber-400"},shoot:{label:"Shoot",icon:"ðŸŽ¬",color:"text-brand-teal"},travel:{label:"Travel",icon:"âœˆï¸",color:"text-indigo-400"}},i=a(e((e,a)=>({events:[],syncStatus:null,lastSyncAt:null,selectedDate:new Date,viewMode:"month",msAccessToken:null,msRefreshToken:null,msTokenExpiry:null,msCalendarId:null,msSyncStatus:null,googleAccessToken:null,googleRefreshToken:null,googleTokenExpiry:null,googleCalendarId:null,googleSyncStatus:null,isLoading:!1,isSyncing:!1,error:null,initialize:async()=>{await a().loadEvents(),await a().checkMicrosoftConnection(),await a().checkGoogleConnection()},loadEvents:async(a,n)=>{e({isLoading:!0,error:null});try{const{data:{user:o}}=await t.auth.getUser();if(!o)throw new Error("Not authenticated");let s=t.from("calendar_events").select("*").eq("user_id",o.id).order("start_time",{ascending:!0});a&&(s=s.gte("start_time",a.toISOString())),n&&(s=s.lte("start_time",n.toISOString()));const{data:r,error:i}=await s;if(i)throw i;e({events:r||[],isLoading:!1})}catch(o){e({isLoading:!1,error:o.message})}},createEvent:async n=>{try{const{data:{user:o}}=await t.auth.getUser();if(!o)throw new Error("Not authenticated");const{data:s,error:r}=await t.from("calendar_events").insert({user_id:o.id,title:n.title,description:n.description,start_time:n.start_time,end_time:n.end_time,location:n.location,event_type:n.event_type||"meeting",status:n.status||"confirmed",all_day:n.all_day||!1,attendees:n.attendees||[],opportunity_id:n.opportunity_id,client_id:n.client_id,reminder_minutes:n.reminder_minutes||15,recurrence:n.recurrence,metadata:n.metadata||{}}).select().single();if(r)throw r;return e({events:[...a().events,s]}),a().msAccessToken&&await a().syncEventToMicrosoft(s),{success:!0,event:s}}catch(o){return{success:!1,error:o.message}}},updateEvent:async(n,o)=>{try{const{data:s,error:r}=await t.from("calendar_events").update({...o,updated_at:(new Date).toISOString()}).eq("id",n).select().single();if(r)throw r;return e({events:a().events.map(e=>e.id===n?s:e)}),a().msAccessToken&&s.external_id&&await a().updateEventInMicrosoft(s),{success:!0,event:s}}catch(s){return{success:!1,error:s.message}}},deleteEvent:async n=>{try{const o=a().events.find(e=>e.id===n),{error:s}=await t.from("calendar_events").delete().eq("id",n);if(s)throw s;return e({events:a().events.filter(e=>e.id!==n)}),a().msAccessToken&&o?.external_id&&await a().deleteEventFromMicrosoft(o.external_id),{success:!0}}catch(o){return{success:!1,error:o.message}}},checkMicrosoftConnection:async()=>{try{const{data:{user:n}}=await t.auth.getUser();if(!n)return;const{data:o}=await t.from("settings").select("data").eq("user_id",n.id).eq("key","microsoft_calendar").single();if(o?.data?.accessToken){new Date(o.data.tokenExpiry)>new Date?e({msAccessToken:o.data.accessToken,msRefreshToken:o.data.refreshToken,msTokenExpiry:o.data.tokenExpiry,msCalendarId:o.data.calendarId,syncStatus:"connected",lastSyncAt:o.data.lastSyncAt}):o.data.refreshToken&&await a().refreshMicrosoftToken(o.data.refreshToken)}}catch(n){}},connectMicrosoft:async()=>{const e=`${window.location.origin}/auth/microsoft/callback`,t=`https://login.microsoftonline.com/common/oauth2/v2.0/authorize?client_id=fd9f6064-152c-4277-b707-e1246c36a95f&response_type=code&redirect_uri=${encodeURIComponent(e)}&scope=${encodeURIComponent("Calendars.ReadWrite offline_access User.Read")}&response_mode=query`;window.location.href=t},handleMicrosoftCallback:async n=>{try{const e=await fetch("https://deitlnfumugxcbxqqivk.supabase.co/functions/v1/microsoft-oauth",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${(await t.auth.getSession()).data.session?.access_token}`},body:JSON.stringify({code:n,redirectUri:`${window.location.origin}/auth/microsoft/callback`})});if(!e.ok)throw new Error("Failed to exchange authorization code");const o=await e.json();return await a().storeMicrosoftTokens(o),await a().syncFromMicrosoft(),{success:!0}}catch(o){return e({error:o.message,syncStatus:"error"}),{success:!1,error:o.message}}},refreshMicrosoftToken:async n=>{try{const e=await fetch("https://deitlnfumugxcbxqqivk.supabase.co/functions/v1/microsoft-oauth",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${(await t.auth.getSession()).data.session?.access_token}`},body:JSON.stringify({refreshToken:n,grantType:"refresh_token"})});if(!e.ok)throw new Error("Failed to refresh token");const o=await e.json();await a().storeMicrosoftTokens(o)}catch(o){e({syncStatus:"error",error:"Session expired. Please reconnect."})}},storeMicrosoftTokens:async a=>{const{data:{user:n}}=await t.auth.getUser();if(!n)return;const o={accessToken:a.access_token,refreshToken:a.refresh_token,tokenExpiry:new Date(Date.now()+1e3*a.expires_in).toISOString(),calendarId:a.calendarId||"primary",lastSyncAt:(new Date).toISOString()};await t.from("settings").upsert({user_id:n.id,key:"microsoft_calendar",data:o}),e({msAccessToken:o.accessToken,msRefreshToken:o.refreshToken,msTokenExpiry:o.tokenExpiry,msCalendarId:o.calendarId,syncStatus:"connected",lastSyncAt:o.lastSyncAt})},disconnectMicrosoft:async()=>{const{data:{user:a}}=await t.auth.getUser();a&&(await t.from("settings").delete().eq("user_id",a.id).eq("key","microsoft_calendar"),e({msAccessToken:null,msRefreshToken:null,msTokenExpiry:null,msCalendarId:null,syncStatus:null}))},syncFromMicrosoft:async()=>{const{msAccessToken:o}=a();if(o){e({isSyncing:!0,syncStatus:"syncing"});try{const s=new Date;s.setDate(s.getDate()-30);const r=new Date;r.setDate(r.getDate()+90);const i=await fetch(`${n}/me/calendar/events?$filter=start/dateTime ge '${s.toISOString()}' and start/dateTime le '${r.toISOString()}'&$orderby=start/dateTime&$top=100`,{headers:{Authorization:`Bearer ${o}`}});if(!i.ok){if(401===i.status)return await a().refreshMicrosoftToken(a().msRefreshToken),await a().syncFromMicrosoft();throw new Error("Failed to fetch Microsoft events")}const c=(await i.json()).value||[],{data:{user:l}}=await t.auth.getUser();if(!l)throw new Error("Not authenticated");for(const e of c){const a={user_id:l.id,external_id:e.id,external_source:"microsoft",title:e.subject,description:e.bodyPreview,start_time:e.start.dateTime+"Z",end_time:e.end.dateTime+"Z",location:e.location?.displayName,all_day:e.isAllDay,status:e.isCancelled?"cancelled":"confirmed",attendees:e.attendees?.map(e=>({email:e.emailAddress.address,name:e.emailAddress.name,response:e.status?.response}))||[],metadata:{webLink:e.webLink,onlineMeetingUrl:e.onlineMeeting?.joinUrl}};await t.from("calendar_events").upsert(a,{onConflict:"external_id,external_source"})}await a().loadEvents();const{data:{user:d}}=await t.auth.getUser();return d&&await t.from("settings").update({data:{...a().msAccessToken&&{accessToken:a().msAccessToken},...a().msRefreshToken&&{refreshToken:a().msRefreshToken},...a().msTokenExpiry&&{tokenExpiry:a().msTokenExpiry},calendarId:a().msCalendarId||"primary",lastSyncAt:(new Date).toISOString()}}).eq("user_id",d.id).eq("key","microsoft_calendar"),e({isSyncing:!1,syncStatus:"connected",lastSyncAt:(new Date).toISOString()}),{success:!0}}catch(s){return e({isSyncing:!1,syncStatus:"error",error:s.message}),{success:!1,error:s.message}}}},syncEventToMicrosoft:async e=>{const{msAccessToken:o}=a();if(o)try{const a={subject:e.title,body:{contentType:"text",content:e.description||""},start:{dateTime:e.start_time,timeZone:"UTC"},end:{dateTime:e.end_time,timeZone:"UTC"},location:e.location?{displayName:e.location}:void 0,isAllDay:e.all_day,attendees:e.attendees?.map(e=>({emailAddress:{address:e.email,name:e.name},type:"required"}))},s=await fetch(`${n}/me/calendar/events`,{method:"POST",headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"},body:JSON.stringify(a)});if(!s.ok)throw new Error("Failed to create Microsoft event");const r=await s.json();await t.from("calendar_events").update({external_id:r.id,external_source:"microsoft"}).eq("id",e.id)}catch(s){}},updateEventInMicrosoft:async e=>{const{msAccessToken:t}=a();if(t&&e.external_id)try{const a={subject:e.title,body:{contentType:"text",content:e.description||""},start:{dateTime:e.start_time,timeZone:"UTC"},end:{dateTime:e.end_time,timeZone:"UTC"},location:e.location?{displayName:e.location}:void 0,isAllDay:e.all_day};await fetch(`${n}/me/calendar/events/${e.external_id}`,{method:"PATCH",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify(a)})}catch(o){}},deleteEventFromMicrosoft:async e=>{const{msAccessToken:t}=a();if(t)try{await fetch(`${n}/me/calendar/events/${e}`,{method:"DELETE",headers:{Authorization:`Bearer ${t}`}})}catch(o){}},checkGoogleConnection:async()=>{try{const{data:{user:n}}=await t.auth.getUser();if(!n)return;const{data:o}=await t.from("settings").select("data").eq("user_id",n.id).eq("key","google_calendar").single();if(o?.data?.accessToken){new Date(o.data.tokenExpiry)>new Date?e({googleAccessToken:o.data.accessToken,googleRefreshToken:o.data.refreshToken,googleTokenExpiry:o.data.tokenExpiry,googleCalendarId:o.data.calendarId||"primary",googleSyncStatus:"connected"}):o.data.refreshToken&&await a().refreshGoogleToken(o.data.refreshToken)}}catch(n){}},connectGoogle:async()=>{const e=`${window.location.origin}/auth/google/callback`,t=`https://accounts.google.com/o/oauth2/v2/auth?client_id=653007939230-mq36ne7sl7h3v17u6tbjh255ksaf67om.apps.googleusercontent.com&redirect_uri=${encodeURIComponent(e)}&scope=${encodeURIComponent("https://www.googleapis.com/auth/calendar")}&response_type=code&access_type=offline&prompt=consent`;window.location.href=t},handleGoogleCallback:async n=>{try{const e=await fetch("https://deitlnfumugxcbxqqivk.supabase.co/functions/v1/google-oauth",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${(await t.auth.getSession()).data.session?.access_token}`},body:JSON.stringify({code:n,redirectUri:`${window.location.origin}/auth/google/callback`})});if(!e.ok)throw new Error("Failed to exchange authorization code");const o=await e.json();return await a().storeGoogleTokens(o),await a().syncFromGoogle(),{success:!0}}catch(o){return e({error:o.message,googleSyncStatus:"error"}),{success:!1,error:o.message}}},refreshGoogleToken:async n=>{try{const e=await fetch("https://deitlnfumugxcbxqqivk.supabase.co/functions/v1/google-oauth",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${(await t.auth.getSession()).data.session?.access_token}`},body:JSON.stringify({refreshToken:n,grantType:"refresh_token"})});if(!e.ok)throw new Error("Failed to refresh Google token");const o=await e.json();await a().storeGoogleTokens(o)}catch(o){e({googleSyncStatus:"error",error:"Session expired. Please reconnect."})}},storeGoogleTokens:async a=>{const{data:{user:n}}=await t.auth.getUser();if(!n)return;const o={accessToken:a.access_token,refreshToken:a.refresh_token,tokenExpiry:new Date(Date.now()+1e3*a.expires_in).toISOString(),calendarId:"primary",lastSyncAt:(new Date).toISOString()};await t.from("settings").upsert({user_id:n.id,key:"google_calendar",data:o}),e({googleAccessToken:o.accessToken,googleRefreshToken:o.refreshToken,googleTokenExpiry:o.tokenExpiry,googleCalendarId:o.calendarId,googleSyncStatus:"connected"})},disconnectGoogle:async()=>{const{data:{user:a}}=await t.auth.getUser();a&&(await t.from("settings").delete().eq("user_id",a.id).eq("key","google_calendar"),e({googleAccessToken:null,googleRefreshToken:null,googleTokenExpiry:null,googleCalendarId:null,googleSyncStatus:null}))},syncFromGoogle:async()=>{const{googleAccessToken:n,googleCalendarId:s}=a();if(n){e({isSyncing:!0,googleSyncStatus:"syncing"});try{const r=new Date,i=new Date(r);i.setDate(i.getDate()-30);const c=new Date(r);c.setDate(c.getDate()+90);const l=await fetch(`${o}/calendars/${s}/events?timeMin=${i.toISOString()}&timeMax=${c.toISOString()}&maxResults=100&orderBy=startTime&singleEvents=true`,{headers:{Authorization:`Bearer ${n}`}});if(!l.ok){if(401===l.status)return await a().refreshGoogleToken(a().googleRefreshToken),await a().syncFromGoogle();throw new Error("Failed to fetch Google events")}const d=(await l.json()).items||[],{data:{user:m}}=await t.auth.getUser();if(!m)throw new Error("Not authenticated");for(const e of d){const a=!!e.start.date,n={user_id:m.id,external_id:e.id,external_source:"google",title:e.summary||"(No title)",description:e.description,start_time:a?new Date(e.start.date).toISOString():e.start.dateTime,end_time:a?new Date(e.end.date).toISOString():e.end.dateTime,location:e.location,all_day:a,status:"cancelled"===e.status?"cancelled":"confirmed",attendees:e.attendees?.map(e=>({email:e.email,name:e.displayName,response:e.responseStatus}))||[],metadata:{webLink:e.htmlLink,onlineMeetingUrl:e.hangoutLink}};await t.from("calendar_events").upsert(n,{onConflict:"external_id,external_source"})}return await a().loadEvents(),e({isSyncing:!1,googleSyncStatus:"connected",lastSyncAt:(new Date).toISOString()}),{success:!0}}catch(r){return e({isSyncing:!1,googleSyncStatus:"error",error:r.message}),{success:!1,error:r.message}}}},syncEventToGoogle:async e=>{const{googleAccessToken:n,googleCalendarId:s}=a();if(n)try{const a={summary:e.title,description:e.description||"",start:e.all_day?{date:e.start_time.split("T")[0]}:{dateTime:e.start_time,timeZone:"UTC"},end:e.all_day?{date:e.end_time.split("T")[0]}:{dateTime:e.end_time,timeZone:"UTC"},location:e.location,attendees:e.attendees?.map(e=>({email:e.email,displayName:e.name}))},r=await fetch(`${o}/calendars/${s}/events`,{method:"POST",headers:{Authorization:`Bearer ${n}`,"Content-Type":"application/json"},body:JSON.stringify(a)});if(!r.ok)throw new Error("Failed to create Google event");const i=await r.json();await t.from("calendar_events").update({external_id:i.id,external_source:"google"}).eq("id",e.id)}catch(r){}},updateEventInGoogle:async e=>{const{googleAccessToken:t,googleCalendarId:n}=a();if(t&&e.external_id)try{const a={summary:e.title,description:e.description||"",start:e.all_day?{date:e.start_time.split("T")[0]}:{dateTime:e.start_time,timeZone:"UTC"},end:e.all_day?{date:e.end_time.split("T")[0]}:{dateTime:e.end_time,timeZone:"UTC"},location:e.location};await fetch(`${o}/calendars/${n}/events/${e.external_id}`,{method:"PUT",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify(a)})}catch(s){}},deleteEventFromGoogle:async e=>{const{googleAccessToken:t,googleCalendarId:n}=a();if(t)try{await fetch(`${o}/calendars/${n}/events/${e}`,{method:"DELETE",headers:{Authorization:`Bearer ${t}`}})}catch(s){}},setSelectedDate:t=>{e({selectedDate:t})},setViewMode:t=>{e({viewMode:t})},getEventsForDate:e=>{const{events:t}=a(),n=e.toISOString().split("T")[0];return t.filter(e=>new Date(e.start_time).toISOString().split("T")[0]===n)},getEventsForRange:(e,t)=>{const{events:n}=a(),o=e.getTime(),s=t.getTime();return n.filter(e=>{const t=new Date(e.start_time).getTime();return t>=o&&t<=s})},getUpcomingEvents:(e=5)=>{const{events:t}=a(),n=new Date;return t.filter(e=>new Date(e.start_time)>n&&"cancelled"!==e.status).sort((e,t)=>new Date(e.start_time)-new Date(t.start_time)).slice(0,e)},reset:()=>{e({events:[],syncStatus:null,lastSyncAt:null,selectedDate:new Date,viewMode:"month",msAccessToken:null,msRefreshToken:null,msTokenExpiry:null,msCalendarId:null,isLoading:!1,isSyncing:!1,error:null})}})));function c(e,t,a){const n=new Date(e),o=new Date(t);if(a)return"All day";const s=new Intl.DateTimeFormat("en-US",{hour:"numeric",minute:"2-digit",hour12:!0});return`${s.format(n)} - ${s.format(o)}`}function l(e){return new Intl.DateTimeFormat("en-US",{weekday:"short",month:"short",day:"numeric"}).format(new Date(e))}function d(e,t){const a=new Date(e),n=new Date(t)-a,o=Math.round(n/6e4);if(o<60)return`${o}m`;const s=Math.floor(o/60),r=o%60;return r>0?`${s}h ${r}m`:`${s}h`}export{r as E,s as a,c as b,l as f,d as g,i as u};
