import{j as e}from"./pdf-vendor-CqWdlgKa.js";import{r as t,R as a}from"./zustand-vendor-BohoUguQ.js";import{g as s,f as r}from"./index-Civi5K2Q.js";import{u as l,E as n,a as o}from"./timelineStore-Bgp0upDS.js";import"./react-vendor-DRPWudcR.js";import"./supabase-vendor-DWEVVlJw.js";const i={active:{bg:"bg-blue-500",border:"border-blue-600"},proposal:{bg:"bg-purple-500",border:"border-purple-600"},negotiation:{bg:"bg-amber-500",border:"border-amber-600"},won:{bg:"bg-green-500",border:"border-green-600"},lost:{bg:"bg-red-500",border:"border-red-600"},dormant:{bg:"bg-gray-500",border:"border-gray-600"}};function c({opp:t,style:s,onClick:r,onDragEnd:l,startDate:n,totalDays:o,containerWidth:c}){const d=i[t.status]||i.active,x=t.probability||50,[m,u]=a.useState(null),[h,p]=a.useState({left:0,width:0}),g=a.useRef(null),b=(e,a)=>{e.preventDefault(),e.stopPropagation(),u(a);const s=e.clientX,r=e=>{const t=(e.clientX-s)/c*100;"move"===a?p({left:t,width:0}):"left"===a?p({left:t,width:-t}):"right"===a&&p({left:0,width:t})},n=e=>{document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",n);const i=e.clientX-s,d=Math.round(i/c*o);if(Math.abs(d)>0){const e=t.createdAt?new Date(t.createdAt):new Date,s=t.expectedCloseDate?new Date(t.expectedCloseDate):new Date;let r=e,n=s;"move"===a?(r=new Date(e.getTime()+24*d*60*60*1e3),n=new Date(s.getTime()+24*d*60*60*1e3)):"left"===a?r=new Date(e.getTime()+24*d*60*60*1e3):"right"===a&&(n=new Date(s.getTime()+24*d*60*60*1e3)),r<n&&l?.(t.id,{createdAt:r.toISOString(),expectedCloseDate:n.toISOString()})}u(null),p({left:0,width:0})};document.addEventListener("mousemove",r),document.addEventListener("mouseup",n)},v={...s,left:`calc(${s.left} + ${h.left}%)`,width:`calc(${s.width} + ${h.width}%)`,opacity:"lost"===t.status?.4:x/100*.5+.5,zIndex:m?20:void 0};return e.jsxs("div",{ref:g,className:`absolute h-8 rounded cursor-grab transition-opacity ${m?"cursor-grabbing":""} ${d.bg} ${d.border} border shadow-sm group`,style:v,onClick:()=>!m&&r(t),onMouseDown:e=>b(e,"move"),title:`${t.title} - ${t.status} (${x}%) - Drag to move, drag edges to resize`,children:[e.jsx("div",{className:"absolute left-0 top-0 bottom-0 w-2 cursor-ew-resize opacity-0 group-hover:opacity-100 hover:bg-white/30 rounded-l transition-opacity",onMouseDown:e=>b(e,"left")}),e.jsx("div",{className:"px-3 py-1 truncate text-xs text-white font-medium select-none",children:t.title}),e.jsx("div",{className:"absolute right-0 top-0 bottom-0 w-2 cursor-ew-resize opacity-0 group-hover:opacity-100 hover:bg-white/30 rounded-r transition-opacity",onMouseDown:e=>b(e,"right")})]})}function d({startDate:t,totalDays:a}){const s=((new Date).getTime()-t.getTime())/864e5/a*100;return s<0||s>100?null:e.jsxs("div",{className:"absolute top-0 bottom-0 w-0.5 bg-red-500 z-20",style:{left:`${s}%`},children:[e.jsx("div",{className:"absolute -top-1 -left-1 w-2 h-2 rounded-full bg-red-500"}),e.jsx("div",{className:"absolute -bottom-5 -left-4 text-[9px] text-red-400 whitespace-nowrap",children:"Today"})]})}function x({event:t,startDate:a,totalDays:s,onClick:r}){const l=(new Date(t.timestamp).getTime()-a.getTime())/864e5/s*100;if(l<0||l>100)return null;const i=n[t.type]||n[o.RESEARCH_FINDING];return e.jsx("div",{className:`absolute top-1 w-3 h-3 rounded-full cursor-pointer transition-transform hover:scale-150 z-10 ${i.bgColor} border ${i.borderColor}`,style:{left:`${l}%`},onClick:()=>r?.(t),title:`${i.label}: ${t.title}`,children:e.jsx("div",{className:"absolute -top-6 left-1/2 -translate-x-1/2 hidden group-hover:block whitespace-nowrap bg-dark-card px-2 py-1 rounded text-xs shadow-lg",children:t.title})})}function m({opportunities:o,onSelectOpportunity:m}){const u=s(e=>e.opportunities),h=s(e=>e.updateOpportunity),p=o||u,{events:g,initialize:b}=l(),[v,j]=t.useState("6m"),[y,f]=t.useState("status"),[N,w]=t.useState(null),[D,k]=t.useState(null),[M,C]=t.useState(!0),[L,S]=t.useState(!1),[E,$]=t.useState(800),T=a.useRef(null),A=a.useRef(null);t.useEffect(()=>{const e=()=>{A.current&&$(A.current.offsetWidth)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]);const z=async(e,t)=>{await h(e,t)};t.useEffect(()=>{b()},[b]);a.useEffect(()=>{const e=()=>{S(!!document.fullscreenElement)};return document.addEventListener("fullscreenchange",e),()=>document.removeEventListener("fullscreenchange",e)},[]);const{startDate:B,endDate:F,totalDays:W}=t.useMemo(()=>{const e=new Date;let t,a;switch(v){case"3m":t=new Date(e.getFullYear(),e.getMonth()-1,1),a=new Date(e.getFullYear(),e.getMonth()+2,0);break;case"6m":t=new Date(e.getFullYear(),e.getMonth()-2,1),a=new Date(e.getFullYear(),e.getMonth()+4,0);break;case"12m":t=new Date(e.getFullYear(),e.getMonth()-3,1),a=new Date(e.getFullYear(),e.getMonth()+9,0);break;default:const s=p.filter(e=>e.createdAt||e.expectedCloseDate).flatMap(e=>[e.createdAt?new Date(e.createdAt):null,e.expectedCloseDate?new Date(e.expectedCloseDate):null]).filter(Boolean);0===s.length?(t=new Date(e.getFullYear(),e.getMonth()-2,1),a=new Date(e.getFullYear(),e.getMonth()+4,0)):(t=new Date(Math.min(...s.map(e=>e.getTime()))),a=new Date(Math.max(...s.map(e=>e.getTime()))),t.setMonth(t.getMonth()-1),a.setMonth(a.getMonth()+1))}return t.setDate(1),a.setDate(28),{startDate:t,endDate:a,totalDays:Math.max(1,(a.getTime()-t.getTime())/864e5)}},[v,p]),I=t.useMemo(()=>function(e,t){const a=[],s=new Date(e);for(s.setDate(1);s<=t;)a.push({key:`${s.getFullYear()}-${s.getMonth()}`,label:s.toLocaleDateString("en-GB",{month:"short",year:"2-digit"}),date:new Date(s)}),s.setMonth(s.getMonth()+1);return a}(B,F),[B,F]),R=t.useMemo(()=>{const e={};p.forEach(t=>{let a;switch(y){case"region":a=t.region||"Other";break;case"country":a=t.country||"Unknown";break;default:a=t.status||"active"}e[a]||(e[a]=[]),e[a].push(t)});return("status"===y?["active","proposal","negotiation","won","lost","dormant"]:Object.keys(e).sort()).filter(t=>e[t]).map(t=>({key:t,label:t.charAt(0).toUpperCase()+t.slice(1),opportunities:e[t].sort((e,t)=>new Date(e.createdAt||0).getTime()-new Date(t.createdAt||0).getTime())}))},[p,y]),V=t.useMemo(()=>{const e=p.filter(e=>["active","proposal","negotiation"].includes(e.status)),t=e.reduce((e,t)=>e+(t.value||0),0),a=e.reduce((e,t)=>e+(t.value||0)*(t.probability||50)/100,0);return{total:p.length,active:e.length,totalValue:t,weightedValue:a}},[p]),Y=e=>{w(e),m&&m(e.id)};return 0===p.length?e.jsxs("div",{className:"card p-8 text-center",children:[e.jsx("svg",{className:"w-12 h-12 mx-auto text-gray-600 mb-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"})}),e.jsx("p",{className:"text-gray-400",children:"No opportunities to display"})]}):e.jsxs("div",{ref:T,className:"space-y-4 "+(L?"bg-dark-bg p-6 overflow-auto h-screen":""),children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-4",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"flex items-center gap-1 bg-dark-card rounded-lg p-1",children:["3m","6m","12m","all"].map(t=>e.jsx("button",{onClick:()=>j(t),className:"px-3 py-1 text-xs rounded-md transition-colors "+(v===t?"bg-accent-primary/20 text-accent-primary":"text-gray-400 hover:text-gray-200"),children:"all"===t?"All":t.toUpperCase()},t))}),e.jsxs("select",{value:y,onChange:e=>f(e.target.value),className:"input-sm bg-dark-card",children:[e.jsx("option",{value:"status",children:"Group by Status"}),e.jsx("option",{value:"region",children:"Group by Region"}),e.jsx("option",{value:"country",children:"Group by Country"})]}),e.jsxs("button",{onClick:()=>C(!M),className:"px-3 py-1.5 text-xs rounded-lg flex items-center gap-1.5 transition-colors "+(M?"bg-blue-500/20 text-blue-400 border border-blue-500/30":"bg-dark-card text-gray-400 hover:text-gray-200"),title:"Toggle research events",children:[e.jsx("svg",{className:"w-3.5 h-3.5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})}),"Research",M&&g.length>0&&e.jsx("span",{className:"bg-blue-500/30 px-1.5 rounded text-[10px]",children:g.length})]})]}),e.jsxs("div",{className:"flex items-center gap-6 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Active: "}),e.jsx("span",{className:"text-gray-200 font-medium",children:V.active})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Pipeline: "}),e.jsx("span",{className:"text-emerald-400 font-medium",children:r(V.totalValue,"USD")})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Weighted: "}),e.jsx("span",{className:"text-amber-400 font-medium",children:r(V.weightedValue,"USD")})]}),e.jsx("button",{onClick:()=>{document.fullscreenElement?(document.exitFullscreen(),S(!1)):(T.current?.requestFullscreen(),S(!0))},className:"p-2 rounded-lg bg-dark-card hover:bg-dark-border transition-colors text-gray-400 hover:text-gray-200",title:L?"Exit fullscreen":"Enter fullscreen",children:L?e.jsx("svg",{className:"w-4 h-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 9L4 4m0 0v4m0-4h4m6 10l5 5m0 0v-4m0 4h-4M9 15l-5 5m0 0h4m-4 0v-4m10-6l5-5m0 0h-4m4 0v4"})}):e.jsx("svg",{className:"w-4 h-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"})})})]})]}),e.jsxs("div",{className:"card overflow-hidden",children:[e.jsxs("div",{className:"flex border-b border-dark-border bg-dark-bg/50",children:[e.jsx("div",{className:"w-48 flex-shrink-0 p-2 border-r border-dark-border",children:e.jsx("span",{className:"text-xs font-medium text-gray-400",children:"Opportunity"})}),e.jsx("div",{className:"flex-1 flex",children:I.map(t=>e.jsx("div",{className:"flex-1 p-2 text-center text-xs text-gray-400 border-r border-dark-border/50 last:border-0",style:{minWidth:"60px"},children:t.label},t.key))})]}),R.map(t=>e.jsxs("div",{children:[e.jsxs("div",{className:"flex bg-dark-bg/30 border-b border-dark-border",children:[e.jsxs("div",{className:"w-48 flex-shrink-0 p-2 border-r border-dark-border",children:[e.jsx("span",{className:"text-xs font-semibold text-gray-300 uppercase",children:t.label}),e.jsxs("span",{className:"text-xs text-gray-500 ml-2",children:["(",t.opportunities.length,")"]})]}),e.jsx("div",{className:"flex-1"})]}),t.opportunities.map(t=>{const a=function(e,t,a,s){const r=e.createdAt?new Date(e.createdAt):t,l=e.expectedCloseDate?new Date(e.expectedCloseDate):a,n=Math.max(r.getTime(),t.getTime()),o=Math.min(l.getTime(),a.getTime()),i=(n-t.getTime())/864e5/s*100,c=Math.max((o-n)/864e5,14)/s*100;return{left:`${Math.max(0,i)}%`,width:`${Math.min(100-i,c)}%`}}(t,B,F,W),s=M?g.filter(e=>e.opportunityId===t.id||e.metadata?.opportunityId===t.id||e.metadata?.country&&e.metadata.country===t.country||e.metadata?.clientId&&e.metadata.clientId===t.clientId):[];return e.jsxs("div",{className:"flex border-b border-dark-border/50 hover:bg-white/5 "+(N?.id===t.id?"bg-accent-primary/10":""),children:[e.jsxs("div",{className:"w-48 flex-shrink-0 p-2 border-r border-dark-border",children:[e.jsx("div",{className:"text-sm text-gray-200 truncate cursor-pointer hover:text-accent-primary",onClick:()=>Y(t),title:t.title,children:t.title}),e.jsxs("div",{className:"text-[10px] text-gray-500 flex items-center gap-2",children:[e.jsx("span",{children:t.country||t.region}),t.value&&e.jsx("span",{className:"text-emerald-400",children:r(t.value,t.currency||"USD")}),s.length>0&&e.jsxs("span",{className:"text-blue-400 flex items-center gap-0.5",children:[e.jsx("svg",{className:"w-3 h-3",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})}),s.length]})]})]}),e.jsxs("div",{ref:A,className:"flex-1 relative h-12 py-2 group",children:[e.jsx("div",{className:"absolute inset-0 flex",children:I.map(t=>e.jsx("div",{className:"flex-1 border-r border-dark-border/20 last:border-0"},t.key))}),e.jsx(d,{startDate:B,totalDays:W}),s.map(t=>e.jsx(x,{event:t,startDate:B,totalDays:W,onClick:e=>k(e)},t.id)),e.jsx(c,{opp:t,style:a,onClick:Y,onDragEnd:z,startDate:B,totalDays:W,containerWidth:E})]})]},t.id)})]},t.key))]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-4 text-xs",children:[e.jsx("span",{className:"text-gray-500",children:"Status:"}),Object.entries(i).map(([t,a])=>e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:`w-3 h-3 rounded ${a.bg}`}),e.jsx("span",{className:"text-gray-400 capitalize",children:t})]},t))]}),N&&e.jsxs("div",{className:"card p-4",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-100",children:N.title}),e.jsxs("div",{className:"text-sm text-gray-400",children:[N.country||N.region,N.client?.company&&` - ${N.client.company}`]})]}),e.jsx("button",{onClick:()=>w(null),className:"text-gray-500 hover:text-gray-300",children:e.jsx("svg",{className:"w-5 h-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-500",children:"Status"}),e.jsx("p",{className:"capitalize text-gray-200",children:N.status})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-500",children:"Value"}),e.jsx("p",{className:"text-emerald-400",children:r(N.value||0,N.currency||"USD")})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-500",children:"Probability"}),e.jsxs("p",{className:"text-gray-200",children:[N.probability||50,"%"]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-500",children:"Expected Close"}),e.jsx("p",{className:"text-gray-200",children:N.expectedCloseDate?new Date(N.expectedCloseDate).toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"}):"-"})]})]}),N.brief&&e.jsxs("div",{className:"mt-3",children:[e.jsx("label",{className:"text-xs text-gray-500",children:"Brief"}),e.jsx("p",{className:"text-sm text-gray-300",children:N.brief})]}),N.nextAction&&e.jsxs("div",{className:"mt-3 p-2 bg-amber-500/10 border border-amber-500/20 rounded",children:[e.jsx("label",{className:"text-xs text-amber-400",children:"Next Action"}),e.jsx("p",{className:"text-sm text-gray-200",children:N.nextAction}),N.nextActionDate&&e.jsxs("p",{className:"text-xs text-amber-400 mt-1",children:["Due: ",new Date(N.nextActionDate).toLocaleDateString("en-GB")]})]})]}),D&&e.jsxs("div",{className:"card p-4 border-l-4 border-blue-500",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:`w-3 h-3 rounded-full ${n[D.type]?.bgColor||"bg-blue-500"}`}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-100",children:D.title}),e.jsxs("div",{className:"text-sm text-gray-400",children:[n[D.type]?.label||"Research Event"," â€¢ ",new Date(D.timestamp).toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"})]})]})]}),e.jsx("button",{onClick:()=>k(null),className:"text-gray-500 hover:text-gray-300",children:e.jsx("svg",{className:"w-5 h-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),D.description&&e.jsx("p",{className:"text-sm text-gray-300 mb-3",children:D.description}),D.metadata&&e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 text-sm",children:[D.metadata.source&&e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-500",children:"Source"}),e.jsx("p",{className:"text-gray-200",children:D.metadata.source})]}),D.metadata.country&&e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-500",children:"Country"}),e.jsx("p",{className:"text-gray-200",children:D.metadata.country})]}),D.metadata.url&&e.jsxs("div",{className:"col-span-2",children:[e.jsx("label",{className:"text-xs text-gray-500",children:"URL"}),e.jsx("a",{href:D.metadata.url,target:"_blank",rel:"noopener noreferrer",className:"text-blue-400 hover:underline truncate block",children:D.metadata.url})]})]})]})]})}export{m as default};
